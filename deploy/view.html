<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜…åå³ç„šæ¶ˆæ¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .timer {
            font-size: 3rem;
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .content-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #dee2e6;
        }
        
        .content {
            font-size: 18px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .destroyed {
            font-size: 24px;
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }
        
        .info {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            color: #666;
            font-size: 18px;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        
        /* é˜²æˆªå›¾ä¿æŠ¤ */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .no-copy {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .timer {
                font-size: 2.5rem;
            }
            
            .content {
                font-size: 16px;
            }
        }
    </style>
</head>
<body class="no-select no-copy" oncontextmenu="return false;">
    <div class="container">
        <div class="header">
            <h1>ğŸ”¥ é˜…åå³ç„šæ¶ˆæ¯</h1>
            <p>æ­¤æ¶ˆæ¯å°†åœ¨é˜…è¯»10ç§’åè‡ªåŠ¨é”€æ¯</p>
        </div>
        
        <div class="timer" id="timer">10</div>
        
        <div class="warning" id="warning">
            âš ï¸ è¯·æ³¨æ„ï¼šæ­¤æ¶ˆæ¯åªèƒ½æŸ¥çœ‹ä¸€æ¬¡ï¼Œ10ç§’åå°†è¢«æ°¸ä¹…é”€æ¯
        </div>
        
        <div class="content-box">
            <div class="content" id="content">
                <div class="loading" id="loading">æ­£åœ¨åŠ è½½æ¶ˆæ¯å†…å®¹...</div>
            </div>
        </div>
        
        <div class="error" id="error" style="display: none;"></div>
        
        <button class="btn" id="destroyBtn" onclick="manualDestroy()" style="display: none;">
            ç«‹å³é”€æ¯
        </button>
        
        <div class="info">
            <p>ğŸ’¡ æ¶ˆæ¯é”€æ¯åæ— æ³•æ¢å¤ï¼Œè¯·ç¡®ä¿å·²é˜…è¯»å®Œæ¯•</p>
            <p>ğŸ‘ï¸ æŸ¥çœ‹æ¬¡æ•°: <span id="viewCount">0</span></p>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let countdownTimer = null;
        let destroyTimer = null;
        let contentId = null;
        let timeLeft = 10;

        // é¡µé¢åŠ è½½æ—¶è·å–å†…å®¹
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            contentId = urlParams.get('id');
            
            if (!contentId) {
                showError('æ— æ•ˆçš„æ¶ˆæ¯é“¾æ¥');
                return;
            }
            
            loadContent();
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢ä¸å¯è§æ—¶æš‚åœè®¡æ—¶
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }
                if (destroyTimer) {
                    clearTimeout(destroyTimer);
                }
            } else {
                // é¡µé¢é‡æ–°å¯è§æ—¶ç»§ç»­è®¡æ—¶
                if (timeLeft > 0) {
                    startTimers();
                }
            }
        });

        // åŠ è½½å†…å®¹
        async function loadContent() {
            try {
                const response = await fetch(`${API_BASE}/content/${contentId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 410) {
                        showDestroyedState('æ­¤æ¶ˆæ¯å·²è¢«é”€æ¯');
                    } else {
                        throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                    }
                    return;
                }
                
                // æ˜¾ç¤ºå†…å®¹
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').innerHTML = `<div>${escapeHtml(data.content)}</div>`;
                document.getElementById('viewCount').textContent = data.view_count;
                
                // è®¡ç®—å‰©ä½™æ—¶é—´ï¼ˆæœ€å¤š10ç§’ï¼‰
                const expiresAt = new Date(data.expires_at || new Date(Date.now() + 10000));
                const timeLeftSeconds = Math.max(0, Math.floor((expiresAt - new Date()) / 1000));
                timeLeft = Math.min(timeLeftSeconds, 10);
                
                // å¦‚æœæŸ¥çœ‹æ¬¡æ•°å·²è¾¾åˆ°æœ€å¤§å€¼ï¼Œæ˜¾ç¤ºè­¦å‘Šä½†å…è®¸æŸ¥çœ‹
                if (data.view_count >= data.max_views) {
                    document.getElementById('warning').innerHTML = 
                        'âš ï¸ æ­¤æ¶ˆæ¯æŸ¥çœ‹æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œä½†ä»å¯æŸ¥çœ‹10ç§’';
                }
                
                startTimers();
                
            } catch (error) {
                showError(error.message);
            }
        }

        // å¯åŠ¨è®¡æ—¶å™¨
        function startTimers() {
            // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            updateTimerDisplay();
            
            // å€’è®¡æ—¶è®¡æ—¶å™¨
            countdownTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    destroyContent();
                }
            }, 1000);
            
            // 10ç§’åè‡ªåŠ¨é”€æ¯
            destroyTimer = setTimeout(() => {
                destroyContent();
            }, timeLeft * 1000);
            
            // æ˜¾ç¤ºé”€æ¯æŒ‰é’®
            document.getElementById('destroyBtn').style.display = 'block';
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer');
            timerElement.textContent = timeLeft;
            
            // é¢œè‰²å˜åŒ–
            if (timeLeft <= 3) {
                timerElement.style.color = '#ff0000';
                timerElement.style.transform = 'scale(1.1)';
            } else if (timeLeft <= 5) {
                timerElement.style.color = '#ff6b6b';
            }
        }

        // é”€æ¯å†…å®¹
        async function destroyContent() {
            try {
                // å‘åç«¯å‘é€é”€æ¯è¯·æ±‚
                const response = await fetch(`${API_BASE}/content/${contentId}/destroy`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('é”€æ¯è¯·æ±‚å¤±è´¥');
                }
                
                // é”€æ¯æˆåŠŸåï¼Œç¦ç”¨é¡µé¢åˆ·æ–°å’Œé‡æ–°åŠ è½½
                disablePageReload();
                showDestroyedState('æ¶ˆæ¯å·²é”€æ¯');
                
            } catch (error) {
                console.error('é”€æ¯å¤±è´¥:', error);
                // å³ä½¿é”€æ¯è¯·æ±‚å¤±è´¥ï¼Œä¹Ÿè¦åœ¨æœ¬åœ°æ ‡è®°ä¸ºå·²é”€æ¯
                disablePageReload();
                showDestroyedState('æ¶ˆæ¯å·²é”€æ¯');
            }
        }
        
        // ç¦ç”¨é¡µé¢åˆ·æ–°å’Œé‡æ–°åŠ è½½
        function disablePageReload() {
            // é˜»æ­¢é¡µé¢åˆ·æ–°
            window.onbeforeunload = function() {
                return 'æ¶ˆæ¯å·²é”€æ¯ï¼Œæ— æ³•é‡æ–°æŸ¥çœ‹ã€‚ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            };
            
            // é˜»æ­¢æµè§ˆå™¨åé€€æŒ‰é’®
            history.pushState(null, null, window.location.href);
            window.addEventListener('popstate', function() {
                history.pushState(null, null, window.location.href);
            });
            
            // é˜»æ­¢å³é”®èœå•å’Œåˆ·æ–°å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // é˜»æ­¢F5åˆ·æ–°
                if (e.key === 'F5') {
                    e.preventDefault();
                    return false;
                }
                // é˜»æ­¢Ctrl+Råˆ·æ–°
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    return false;
                }
                // é˜»æ­¢Ctrl+Shift+Rå¼ºåˆ¶åˆ·æ–°
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    return false;
                }
            });
        }

        // æ‰‹åŠ¨é”€æ¯
        function manualDestroy() {
            if (confirm('ç¡®å®šè¦ç«‹å³é”€æ¯æ­¤æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                if (countdownTimer) clearInterval(countdownTimer);
                if (destroyTimer) clearTimeout(destroyTimer);
                destroyContent();
            }
        }

        // æ˜¾ç¤ºé”€æ¯çŠ¶æ€
        function showDestroyedState(message) {
            document.getElementById('timer').textContent = '0';
            document.getElementById('timer').style.color = '#ff0000';
            document.getElementById('content').innerHTML = 
                `<div class="destroyed">${message}</div>`;
            document.getElementById('destroyBtn').style.display = 'none';
            
            // æ¸…é™¤è®¡æ—¶å™¨
            if (countdownTimer) clearInterval(countdownTimer);
            if (destroyTimer) clearTimeout(destroyTimer);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é˜²æ­¢å³é”®èœå•
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });

        // é˜²æ­¢æ‹–æ‹½
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
    </script>
</body>
</html>